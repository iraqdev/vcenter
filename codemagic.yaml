workflows:
  ios-release:
    name: VCenter iOS Release Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - ios-release
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.dnzteam.vcenter
        # Codemagic Ø³ÙŠØ®ØªØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ DIST_CERT Ùˆ DIST_PROFILE
        # Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ bundle_identifier Ùˆ distribution_type
      
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        # App Store Connect API credentials
        # ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Codemagic UI: Environment variables
        APP_STORE_CONNECT_ISSUER_ID: dca6b398-f004-41b8-98ce-ef6553d892ea
        APP_STORE_CONNECT_KEY_IDENTIFIER: 5RU583BNQ3
        # APP_STORE_CONNECT_PRIVATE_KEY Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ€ secure variable
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
    
    scripts:
      - name: Get Flutter packages
        script: |
          flutter pub get
      
      - name: Verify iOS deployment target
        script: |
          echo "ğŸ” Checking iOS deployment target settings..."
          cd ios
          echo "Podfile platform:"
          grep "platform :ios" Podfile || echo "âš ï¸ Platform not found in Podfile"
          echo "AppFrameworkInfo.plist MinimumOSVersion:"
          grep -A 1 "MinimumOSVersion" Flutter/AppFrameworkInfo.plist || echo "âš ï¸ MinimumOSVersion not found"
          echo "Xcode project IPHONEOS_DEPLOYMENT_TARGET:"
          grep "IPHONEOS_DEPLOYMENT_TARGET" Runner.xcodeproj/project.pbxproj | head -1 || echo "âš ï¸ IPHONEOS_DEPLOYMENT_TARGET not found"
      
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          # ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª CocoaPods
          rm -rf Pods
          rm -rf Podfile.lock
          rm -rf .symlinks
          rm -rf Flutter/Flutter.framework
          rm -rf Flutter/Flutter.podspec
          rm -rf ~/Library/Caches/CocoaPods
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Podfile
          echo "ğŸ“‹ Podfile content:"
          cat Podfile | grep -A 2 "platform :ios"
          # ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª CocoaPods
          pod repo update
          # ØªØ«Ø¨ÙŠØª dependencies
          pod install --repo-update --verbose
      
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      
      - name: Verify code signing setup
        script: |
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† provisioning profiles ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          echo "âœ… Code signing setup completed"
      
      - name: Set up Firebase (if needed)
        script: |
          # Firebase config files should be in the repository
          # ios/Runner/GoogleService-Info.plist
          # android/app/google-services.json
          echo "âœ… Firebase config files already in repository"
      
      - name: Build iOS
        script: |
          flutter build ipa --release \
            --export-options-plist=$HOME/export_options.plist
      
      - name: Ensure App Store Connect key env
        script: |
          if [ -z "${APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY}" ] && [ -n "${APP_STORE_CONNECT_PRIVATE_KEY}" ]; then
            export APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY="${APP_STORE_CONNECT_PRIVATE_KEY}"
            echo "APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY populated from APP_STORE_CONNECT_PRIVATE_KEY"
          fi
    
    artifacts:
      - build/ios/ipa/*.ipa
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    
    publishing:
      email:
        recipients:
          - jaafar.albanaa@gmail.com
        notify:
          success: true
          failure: true
      
      app_store_connect:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ§ØªÙŠØ­ App Store Connect Ø¹Ø¨Ø± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        api_key: $APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true

