workflows:
  ios-release:
    name: iOS Release Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - ios-release
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.dnzteam.vcenter
        # Codemagic Ø³ÙŠØ®ØªØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ DIST_CERT Ùˆ DIST_PROFILE
        # Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ bundle_identifier Ùˆ distribution_type
      
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        # App Store Connect API credentials
        # ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Codemagic UI: Environment variables
        APP_STORE_CONNECT_ISSUER_ID: dca6b398-f004-41b8-98ce-ef6553d892ea
        APP_STORE_CONNECT_KEY_IDENTIFIER: 5RU583BNQ3
        # APP_STORE_CONNECT_PRIVATE_KEY Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ€ secure variable
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
    
    scripts:
      - name: Get Flutter packages
        script: |
          flutter pub get
      
      - name: Create .env file if missing
        script: |
          if [ ! -f .env ]; then
            echo "Creating empty .env file..."
            touch .env
            echo "# Environment variables" >> .env
            echo "# API_BASE_URL=https://dalilakauto.com" >> .env
            echo "# API_KEY=1234567890" >> .env
            echo "âœ… Created .env file"
          else
            echo "âœ… .env file already exists"
          fi
      
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          rm -f Podfile.lock
          pod repo update
          pod update StripePaymentsUI
          pod install --repo-update
      
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      
      - name: Generate Flutter build files
        script: |
          # ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª Flutter Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Generated.xcconfig, etc)
          flutter build ios --config-only
      
      - name: Build iOS for App Store
        script: |
          flutter build ipa --release \
            --export-options-plist=$HOME/export_options.plist
      
      - name: Build iOS for Simulator (Appetize.io)
        script: |
          set -e
          
          echo "ğŸ“± Building iOS app for simulator (Appetize.io)..."
          echo "According to Appetize.io: 'For iOS, upload a .zip or .tar.gz file containing your compressed .app bundle'"
          echo "âš ï¸ Important: Must build for iphonesimulator SDK, not device!"
          echo "âš ï¸ Note: Flutter doesn't support Release mode for simulators, using Debug mode instead"
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Flutter build Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ - Debug mode (Release ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ)
          echo "ğŸ”¨ Building for iOS Simulator using Flutter (Debug mode)..."
          flutter build ios --debug --simulator
          
          echo "âœ… iOS simulator build completed"
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† .app Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ
          echo "ğŸ” Searching for simulator .app file..."
          
          # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DerivedData Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ - Debug (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ø£Ù†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ --debug)
          SIMULATOR_APP=$(find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Debug-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
          [ -n "$SIMULATOR_APP" ] && echo "âœ… Found in Debug-iphonesimulator: $SIMULATOR_APP"
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Release (ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø¨Ù†Ø§Ø¡ Ø³Ø§Ø¨Ù‚)
          if [ -z "$SIMULATOR_APP" ]; then
            SIMULATOR_APP=$(find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
            [ -n "$SIMULATOR_APP" ] && echo "âœ… Found in Release-iphonesimulator: $SIMULATOR_APP"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ
          if [ -z "$SIMULATOR_APP" ]; then
            SIMULATOR_APP=$(find $HOME/Library/Developer/Xcode/DerivedData -name "Runner.app" -type d -path "*iphonesimulator*" 2>/dev/null | head -1)
            [ -n "$SIMULATOR_APP" ] && echo "âœ… Found in any iphonesimulator path: $SIMULATOR_APP"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ build/ios
          if [ -z "$SIMULATOR_APP" ]; then
            SIMULATOR_APP=$(find build/ios -name "Runner.app" -type d -path "*iphonesimulator*" 2>/dev/null | head -1)
            [ -n "$SIMULATOR_APP" ] && echo "âœ… Found in build/ios: $SIMULATOR_APP"
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
          if [ -z "$SIMULATOR_APP" ] || [ ! -d "$SIMULATOR_APP" ]; then
            echo ""
            echo "âŒ Simulator .app file not found!"
            echo ""
            echo "Searching all locations..."
            echo ""
            echo "Default DerivedData (Debug-iphonesimulator):"
            find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Debug-iphonesimulator/*.app" -type d 2>/dev/null | head -5 || echo "  (none found)"
            echo ""
            echo "Default DerivedData (Release-iphonesimulator):"
            find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphonesimulator/*.app" -type d 2>/dev/null | head -5 || echo "  (none found)"
            echo ""
            echo "All .app files in DerivedData:"
            find $HOME/Library/Developer/Xcode/DerivedData -name "Runner.app" -type d 2>/dev/null | head -10 || echo "  (none found)"
            echo ""
            echo "build/ios directory:"
            find build/ios -name "*.app" -type d 2>/dev/null | head -5 || echo "  (none found)"
            echo ""
            echo "âŒ Build may have failed or .app was not created"
            exit 1
          fi
          
          echo ""
          echo "âœ… Simulator .app found: $SIMULATOR_APP"
          ls -lh "$SIMULATOR_APP"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ
          if echo "$SIMULATOR_APP" | grep -q "iphonesimulator"; then
            echo "âœ… Confirmed: This is a simulator build (iphonesimulator)"
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ù„Ù„Ø¬Ù‡Ø§Ø²
            if echo "$SIMULATOR_APP" | grep -q "iphoneos"; then
              echo "âŒ ERROR: This is a device build, not simulator!"
              exit 1
            fi
            
            # Ù†Ø³Ø® .app Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† Ù…Ø¹Ø±ÙˆÙ
            mkdir -p "$HOME/clone/build/simulator-app"
            cp -R "$SIMULATOR_APP" "$HOME/clone/build/simulator-app/"
            echo "âœ… Copied .app to: $HOME/clone/build/simulator-app/Runner.app"
          else
            echo "âš ï¸ Warning: Path doesn't contain 'iphonesimulator'"
            echo "   File: $SIMULATOR_APP"
            echo "   This might not be a simulator build!"
          fi
      
      - name: Create Appetize.io package
        script: |
          set -e  # Exit on any error
          
          echo "ğŸ“¦ Creating Appetize.io package..."
          echo "Appetize.io requirement: 'For iOS, upload a .zip or .tar.gz file containing your compressed .app bundle'"
          echo "âš ï¸ CRITICAL: Must be a simulator build (iphonesimulator), not device (iphoneos)!"
          
          # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
          ARTIFACTS_DIR="$HOME/clone/build"
          ZIP_FILE="$ARTIFACTS_DIR/appetize-ios-app.zip"
          TAR_GZ_FILE="$ARTIFACTS_DIR/appetize-ios-app.tar.gz"
          APP_FILE=""
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ artifacts Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          mkdir -p "$ARTIFACTS_DIR"
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù .app Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ ÙÙ‚Ø·
          echo "ğŸ” Searching for simulator .app file..."
          
          # Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
          if [ -d "$HOME/clone/build/simulator-app/Runner.app" ]; then
            APP_FILE="$HOME/clone/build/simulator-app/Runner.app"
            echo "âœ… Found .app in predefined location: $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DerivedData Ø§Ù„Ù…Ø­Ø¯Ø¯
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            BUILD_DIR="$HOME/clone/build/simulator-build"
            APP_FILE=$(find "$BUILD_DIR/DerivedData" -path "*/Build/Products/Release-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in custom DerivedData: $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Debug
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            BUILD_DIR="$HOME/clone/build/simulator-build"
            APP_FILE=$(find "$BUILD_DIR/DerivedData" -path "*/Build/Products/Debug-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in Debug build: $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ ÙÙŠ DerivedData Ø§Ù„Ù…Ø­Ø¯Ø¯
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            BUILD_DIR="$HOME/clone/build/simulator-build"
            APP_FILE=$(find "$BUILD_DIR/DerivedData" -name "Runner.app" -type d -path "*iphonesimulator*" 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in custom DerivedData (any config): $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DerivedData Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ - Release
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            APP_FILE=$(find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in default DerivedData (Release): $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Debug
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            APP_FILE=$(find $HOME/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Debug-iphonesimulator/Runner.app" -type d 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in default DerivedData (Debug): $APP_FILE"
          fi
          
          # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙˆØ¬Ø¯ØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ ÙÙ‚Ø·
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            APP_FILE=$(find $HOME/Library/Developer/Xcode/DerivedData -name "Runner.app" -type d -path "*iphonesimulator*" 2>/dev/null | head -1)
            [ -n "$APP_FILE" ] && echo "âœ… Found in default DerivedData (any config): $APP_FILE"
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ‡Ùˆ Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ
          if [ -z "$APP_FILE" ] || [ ! -d "$APP_FILE" ]; then
            echo "âŒ Simulator .app file not found!"
            echo ""
            echo "Searching in all locations..."
            echo ""
            echo "Custom build directory:"
            find "$HOME/clone/build" -name "*.app" -type d 2>/dev/null | head -5 || echo "  (none found)"
            echo ""
            echo "DerivedData simulator builds (iphonesimulator):"
            find $HOME/Library/Developer/Xcode/DerivedData -name "*.app" -type d -path "*iphonesimulator*" 2>/dev/null | head -10 || echo "  (none found)"
            echo ""
            echo "All .app files in DerivedData:"
            find $HOME/Library/Developer/Xcode/DerivedData -name "Runner.app" -type d 2>/dev/null | head -10 || echo "  (none found)"
            echo ""
            echo "âŒ Cannot create Appetize.io package without simulator .app file"
            exit 1
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ ÙˆÙ„ÙŠØ³ Ù„Ù„Ø¬Ù‡Ø§Ø²
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
          if echo "$APP_FILE" | grep -q "iphoneos"; then
            echo "âŒ ERROR: Found device build (iphoneos), not simulator!"
            echo "   File: $APP_FILE"
            echo "   Appetize.io requires simulator build (iphonesimulator)"
            exit 1
          fi
          
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ iphonesimulatorØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          if ! echo "$APP_FILE" | grep -q "iphonesimulator"; then
            echo "âš ï¸ Path doesn't contain 'iphonesimulator', checking file contents..."
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… file Ø£Ùˆ otool
            if command -v file >/dev/null 2>&1; then
              FILE_TYPE=$(file "$APP_FILE/Runner" 2>/dev/null || echo "")
              if echo "$FILE_TYPE" | grep -qi "simulator\|x86_64\|arm64.*simulator"; then
                echo "âœ… Confirmed: File type indicates simulator build"
                echo "   Type: $FILE_TYPE"
              elif echo "$FILE_TYPE" | grep -qi "arm64.*device\|armv7"; then
                echo "âŒ ERROR: File type indicates device build, not simulator!"
                echo "   Type: $FILE_TYPE"
                exit 1
              else
                echo "âš ï¸ Could not determine build type from file command"
                echo "   Type: $FILE_TYPE"
              fi
            fi
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… otool (Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©)
            if command -v otool >/dev/null 2>&1 && [ -f "$APP_FILE/Runner" ]; then
              ARCHS=$(otool -l "$APP_FILE/Runner" 2>/dev/null | grep -A 5 "LC_VERSION_MIN\|LC_BUILD_VERSION" | head -10 || echo "")
              if echo "$ARCHS" | grep -qi "iphonesimulator\|simulator"; then
                echo "âœ… Confirmed: Binary indicates simulator build"
              elif echo "$ARCHS" | grep -qi "iphoneos"; then
                echo "âŒ ERROR: Binary indicates device build, not simulator!"
                exit 1
              else
                echo "âš ï¸ Could not determine build type from otool"
              fi
            fi
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ (build/simulator-app)ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ØµØ­ÙŠØ­Ø§Ù‹
            if echo "$APP_FILE" | grep -q "build/simulator-app"; then
              echo "âœ… File is from simulator build directory, assuming simulator build"
            else
              echo "âŒ ERROR: Cannot confirm this is a simulator build!"
              echo "   File: $APP_FILE"
              echo "   Path must contain 'iphonesimulator' or be from simulator build"
              exit 1
            fi
          fi
          
          echo ""
          echo "âœ… Found simulator .app file: $APP_FILE"
          echo "   Size: $(du -sh "$APP_FILE" | cut -f1)"
          echo "   Path: $APP_FILE"
          echo "âœ… Confirmed: This is a simulator build (iphonesimulator)"
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .app
          APP_DIR=$(dirname "$APP_FILE")
          APP_NAME=$(basename "$APP_FILE")
          
          echo ""
          echo "ğŸ“¦ Creating compressed .app bundle as required by Appetize.io..."
          echo "   Source: $APP_FILE"
          echo "   Output: $ZIP_FILE and $TAR_GZ_FILE"
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .app
          cd "$APP_DIR"
          
          # Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
          [ -f "$ZIP_FILE" ] && rm -f "$ZIP_FILE"
          [ -f "$TAR_GZ_FILE" ] && rm -f "$TAR_GZ_FILE"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù zip ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .app Ù…Ø¨Ø§Ø´Ø±Ø©
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙŠØ§Ø±Ø§Øª zip Ù…Ø­Ø³Ù‘Ù†Ø©: -q (quiet), -r (recursive), -y (symlinks)
          echo "   Creating ZIP archive..."
          zip -qry "$ZIP_FILE" "$APP_NAME" || {
            echo "âŒ Failed to create ZIP file"
            exit 1
          }
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù tar.gz ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .app Ù…Ø¨Ø§Ø´Ø±Ø©
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙŠØ§Ø±Ø§Øª tar Ù…Ø­Ø³Ù‘Ù†Ø©: -c (create), -z (gzip), -f (file)
          echo "   Creating TAR.GZ archive..."
          tar -czf "$TAR_GZ_FILE" "$APP_NAME" || {
            echo "âŒ Failed to create TAR.GZ file"
            exit 1
          }
          
          # Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
          cd "$HOME/clone"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª
          if [ ! -f "$ZIP_FILE" ]; then
            echo "âŒ ZIP file was not created: $ZIP_FILE"
            exit 1
          fi
          
          if [ ! -f "$TAR_GZ_FILE" ]; then
            echo "âŒ TAR.GZ file was not created: $TAR_GZ_FILE"
            exit 1
          fi
          
          echo ""
          echo "âœ… Created Appetize.io packages:"
          echo "   ğŸ“¦ ZIP:  $ZIP_FILE ($(du -h "$ZIP_FILE" | cut -f1))"
          echo "   ğŸ“¦ TAR:  $TAR_GZ_FILE ($(du -h "$TAR_GZ_FILE" | cut -f1))"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† .app Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©
          echo ""
          echo "ğŸ“‹ Verifying ZIP contents (should contain $APP_NAME directly):"
          unzip -l "$ZIP_FILE" | head -20 || echo "  (verification failed)"
          
          echo ""
          echo "ğŸ“‹ Verifying TAR.GZ contents:"
          tar -tzf "$TAR_GZ_FILE" | head -10 || echo "  (verification failed)"
          
          echo ""
          echo "âœ… Package ready for Appetize.io upload!"
          echo "   Recommended: Use $ZIP_FILE"
          echo "   Alternative: Use $TAR_GZ_FILE"
      
      - name: Ensure App Store Connect key env
        script: |
          if [ -z "${APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY}" ] && [ -n "${APP_STORE_CONNECT_PRIVATE_KEY}" ]; then
            export APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY="${APP_STORE_CONNECT_PRIVATE_KEY}"
            echo "APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY populated from APP_STORE_CONNECT_PRIVATE_KEY"
          fi
    
    artifacts:
      - build/ios/ipa/*.ipa
      - build/appetize-ios-app.zip
      - build/appetize-ios-app.tar.gz
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    
    publishing:
      email:
        recipients:
          - jaafar.albanaa@gmail.com
        notify:
          success: true
          failure: true
      
      app_store_connect:
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ§ØªÙŠØ­ App Store Connect Ø¹Ø¨Ø± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        api_key: $APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true

